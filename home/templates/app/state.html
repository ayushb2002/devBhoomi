{% extends 'home/base.html' %}
{% load static %}
{% load js %}

{% block title %}
State - {{ state }}
{% endblock %}

{% block additional_scripts %}
<link rel="stylesheet" href="{% static 'css/image-zoom.css' %}" />
<script src="{% static 'js/image-zoom.min.js' %}"></script>
<script>
    function zoom(e){
        var zoomer = e.currentTarget;
        e.offsetX ? offsetX = e.offsetX : offsetX = e.touches[0].pageX
        e.offsetY ? offsetY = e.offsetY : offsetX = e.touches[0].pageX
        x = offsetX/zoomer.offsetWidth*100
        y = offsetY/zoomer.offsetHeight*100
        zoomer.style.backgroundPosition = x + '% ' + y + '%';
    }

    $(document).ready(() => {
        const distList = [];
        const aLinks = document.querySelectorAll('.dist-link');
        aLinks.forEach(link => {
            link.setAttribute('href', `/district/${slugify('{{state}}')}/${slugify(link.innerText)}`);
        });

        document.getElementById('stateForm').action = `/state/map/${slugify('{{state}}')}`
        var acts = {{acts | js}}
        var crimes = {{crimes | js}}

        const actSelect = document.getElementById('actSelect')
        const crimeSelect = document.getElementById('crimeSelect')
        
        acts.forEach(a => {
            var opte = document.createElement('option')
            opte.text = a
            opte.value = a
            actSelect.options.add(opte)
        })

        $('#actSelect').change(() => {
            var str = $('#actSelect').val();
            const idx = acts.indexOf(str);
            crimes[idx].forEach(c => {
                var opte = document.createElement('option')
                opte.text = c;
                opte.value = c;
                crimeSelect.options.add(opte);
            });
        });
});
</script>
<style>
    figure.zoom {
        background-position: 50% 50%;
        position: relative;
        margin: 150px auto;
        border: 5px solid white;
        height: 700px;
        width: 900px;
        overflow: hidden;
        cursor: zoom-in;
    }

    figure.zoom img:hover {
        opacity: 0;
    }
    figure.zoom img {
        transition: opacity 0.5s;
        display: block;
        width: 100%;
        height: 100%;
    }
</style>
{% endblock %}

{% block body %}
{% include "nav/navbar.html" %}
<div class="flex flex-col items-center justify-center mt-4 space-y-4">
    <h1 class="text-3xl">Crime Hotspot Viewer for state of <span class="font-bold text-green-500">{{state}}</span></h1>
    <!-- Map Here -->
    <!-- District List -->
    {% if act and crime %}
    <h3 class="text-2xl text-green-500">Report of {{crime}} under {{act}} in {{state}}</h3>
    {% else %}
    <h3 class="text-2xl text-green-500">Select Act and Crime to get Report</h3>
    {% endif %}
    
    <form id="stateForm" method="post" class="flex flex-col gap-4 items-center justify-between">
        {% csrf_token %}
        <select name="act" id="actSelect" class="select select-accent w-full max-w-lg">
            <option disabled selected>Select Act</option>
        </select>
        <select name="crime" id="crimeSelect" class="select select-accent w-full max-w-lg">
            <option disabled selected>Select Crime</option>
        </select>
        <button type="submit" class="btn btn-accent w-full max-w-lg">
            Get Report
        </button>
    </form>
    {% if map %}
        <!-- <img src="data:image/png;base64, {{map|safe}}" style="object-fit: contain;" height="600px" width="600px" id="chart" alt="{{state}}" /> -->
        <figure class="zoom" onmousemove="zoom(event)" style="background-image: url('data:image/png;base64, {{map|safe}}')">
            <img src="data:image/png;base64, {{map|safe}}" id="chart" alt="{{state}}" />
        </figure>
    {% endif %}
</div>
{% endblock %}